# docker-compose.yml
# BASTION - Caldera-Wazuh Integration Platform
# Unified Docker Compose for development

services:
  # Wazuh Manager
  wazuh.manager:
    image: wazuh/wazuh-manager:4.14.1
    hostname: wazuh.manager
    restart: always
    ports:
      - "11514:1514"      # Agent communication
      - "1515:1515"      # Agent enrollment
      - "55600:55000"    # API
    environment:
      - INDEXER_URL=http://elasticsearch:9200
      - INDEXER_USERNAME=${ELASTIC_USERNAME}
      - INDEXER_PASSWORD=${ELASTIC_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - API_USERNAME=wazuh
      - API_PASSWORD=MyS3cur3P@ssw0rd!
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      # Custom optimized ossec.conf (reduced ruleset for memory optimization)
      - ./wazuh-rules/ossec_custom.conf:/var/ossec/etc/ossec.conf
      # Custom Caldera detection rules
      - ./wazuh-rules/caldera_detection_rules.xml:/var/ossec/etc/rules/caldera_detection_rules.xml
      # Wazuh internal options (JSON decoder field limit)
      - ./wazuh-rules/local_internal_options.conf:/var/ossec/etc/local_internal_options.conf
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
    networks:
      - bastion-network

 # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - es-config:/usr/share/elasticsearch/config
    networks:
      - bastion-network

  # Kibana
  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${KIBANA_SYSTEM_PASSWORD}
      - XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY=0123456789abcdef0123456789abcdef
      - XPACK_SECURITY_ENCRYPTIONKEY=abcdef0123456789abcdef0123456789
      - XPACK_REPORTING_ENCRYPTIONKEY=1234567890abcdef1234567890abcdef
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - bastion-network


  # Caldera 5.3.0 with BASTION Plugin
  caldera:
    build:
      context: ./caldera
      dockerfile: Dockerfile
    image: caldera:5.3-bastion
    hostname: caldera
    restart: always
    ports:
      - "8888:8888"      # Web interface
      - "8443:8443"      # HTTPS interface
      - "7010:7010"      # TCP contact
      - "7011:7011/udp"  # UDP contact
      - "7012:7012"      # WebSocket
      - "8853:8853"      # DNS tunneling
      - "8022:8022"      # SSH tunneling
      - "2222:2222"      # FTP C2
    environment:
      - WAZUH_MANAGER_URL=https://wazuh.manager:55000
      - WAZUH_INDEXER_URL=http://elasticsearch:9200
      - WAZUH_USERNAME=wazuh
      - WAZUH_PASSWORD=MyS3cur3P@ssw0rd!
      - WAZUH_INDEXER_USERNAME=elastic
      - WAZUH_INDEXER_PASSWORD=Kimdong2024
      - ELASTIC_USERNAME=${ELASTIC_USERNAME}
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
    volumes:
      # BASTION plugin configuration
      - ./caldera/conf/local.yml:/usr/src/app/conf/local.yml
      - ./caldera/conf/agents.yml:/usr/src/app/conf/agents.yml
      - ./caldera/conf/payloads.yml:/usr/src/app/conf/payloads.yml
      # BASTION integration engine config
      - ./caldera/plugins/bastion/app/conf/default.yml:/usr/src/app/plugins/bastion/app/conf/default.yml
      # BASTION plugin source code (개별 파일 마운트로 opensearch-py 보존)
      - ./caldera/plugins/bastion/app/bastion_service.py:/usr/src/app/plugins/bastion/app/bastion_service.py
      - ./caldera/plugins/bastion/app/integration_engine.py:/usr/src/app/plugins/bastion/app/integration_engine.py
      # BASTION GUI view
      - ./caldera/plugins/bastion/gui/views/bastion.vue:/usr/src/app/plugins/bastion/gui/views/bastion.vue
      # Persist Caldera data
      - caldera_data:/usr/src/app/data
    depends_on:
      - wazuh.manager
      - elasticsearch
    command: ["--insecure"]
    networks:
      - bastion-network

volumes:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_integrations:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:
  wazuh-indexer-data:
  wazuh-dashboard-config:
  wazuh-dashboard-custom:
  caldera_data:
  es-data:
  es-config:

networks:
  bastion-network:
    driver: bridge
